<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ramadan Social Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --vh: 1vh; }
        body { height: calc(var(--vh) * 100); display: flex; flex-direction: column; overflow: hidden; background: #fff; }
        
        #splash { position: fixed; inset: 0; background: #fff; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #login-page { position: fixed; inset: 0; background: linear-gradient(135deg, #0084ff, #00c6ff); z-index: 900; display: none; flex-direction: column; justify-content: center; align-items: center; }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #f9f9f9; }
        
        .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; position: relative; }
        .my-msg { background: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .other-msg { background: #fff; color: #000; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .input-sticky { background: white; padding: 10px 15px; border-top: 1px solid #eee; padding-bottom: calc(env(safe-area-inset-bottom) + 10px); }
        
        .loader { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0084ff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="splash">
        <i class="fa-solid fa-moon text-6xl text-blue-600 mb-4 animate-pulse"></i>
        <h2 class="text-xl font-bold">Ramadan Social</h2>
        <div class="loader mt-4"></div>
    </div>

    <div id="login-page" class="text-white">
        <i class="fa-solid fa-comments text-7xl mb-6"></i>
        <h1 class="text-3xl font-bold mb-2">Welcome!</h1>
        <p class="mb-10 opacity-90">চ্যাট করতে গুগল দিয়ে লগইন করুন</p>
        <button id="google-login" class="bg-white text-blue-600 px-8 py-3 rounded-full font-bold shadow-xl flex items-center gap-3 active:scale-95 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/0/google.svg" class="w-5">
            Google Login
        </button>
    </div>

    <div id="main-app" class="hidden flex flex-col h-full">
        <header class="p-3 border-b flex justify-between items-center bg-white shrink-0">
            <h1 class="text-2xl font-black text-blue-600">Chats</h1>
            <div class="flex items-center gap-3">
                <img id="my-pic" class="w-8 h-8 rounded-full border">
                <button id="logout-btn" class="text-gray-400"><i class="fa-solid fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div id="chat-window"></div>

        <div class="input-sticky shrink-0">
            <div class="flex items-center gap-3">
                <div class="flex-1 bg-gray-100 rounded-full px-4 py-2">
                    <input id="msg-input" type="text" placeholder="মেসেজ লিখুন..." class="bg-transparent w-full outline-none text-sm">
                </div>
                <button id="send-btn" class="text-blue-500 text-2xl"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDzypoA8g3948i7oFrCrge8E3ZW_Xc3IdM",
            authDomain: "ramadan-social.firebaseapp.com",
            projectId: "ramadan-social",
            storageBucket: "ramadan-social.firebasestorage.app",
            messagingSenderId: "710798149184",
            appId: "1:710798149184:web:5e1ae45b1f8dcc5bbcc1a5",
            databaseURL: "https://ramadan-social-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Mobile Viewport Fix
        const fixVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
        window.addEventListener('resize', fixVh);
        fixVh();

        // Auth Logic
        onAuthStateChanged(auth, (user) => {
            setTimeout(() => { document.getElementById('splash').style.display = 'none'; }, 1000);
            if (user) {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('my-pic').src = user.photoURL;
                startChat();
            } else {
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('main-app').classList.add('hidden');
            }
        });

        document.getElementById('google-login').onclick = () => {
            setPersistence(auth, browserLocalPersistence).then(() => signInWithPopup(auth, provider));
        };

        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // Chat Logic
        function startChat() {
            const win = document.getElementById('chat-window');
            win.innerHTML = ""; 
            
            // নতুন ডাটাবেস পাথ যাতে পুরনো undefined ডেটা না আসে
            onChildAdded(ref(db, 'ramadan_final_chats'), (snap) => {
                const d = snap.val();
                if(!d.text) return; // ফিল্টারিং যাতে ভুল ডেটা না দেখায়

                const isMe = d.uid === auth.currentUser.uid;
                const time = d.time ? new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

                const html = `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        ${!isMe ? `<span class="text-[10px] text-gray-500 mb-1 ml-2 font-bold">${d.name}</span>` : ''}
                        <div class="flex items-end gap-2 ${isMe ? 'flex-row-reverse' : ''}">
                            <img src="${d.photo}" class="w-6 h-6 rounded-full">
                            <div class="msg-bubble ${isMe ? 'my-msg shadow-md' : 'other-msg shadow-sm'}">
                                <p>${d.text}</p>
                                <p class="text-[8px] mt-1 text-right opacity-50">${time}</p>
                            </div>
                        </div>
                    </div>
                `;
                win.insertAdjacentHTML('beforeend', html);
                win.scrollTop = win.scrollHeight;
            });
        }

        const sendMsg = () => {
            const input = document.getElementById('msg-input');
            const val = input.value.trim();
            if (val) {
                push(ref(db, 'ramadan_final_chats'), {
                    uid: auth.currentUser.uid,
                    name: auth.currentUser.displayName,
                    photo: auth.currentUser.photoURL,
                    text: val,
                    time: serverTimestamp()
                });
                input.value = "";
                input.focus();
            }
        };

        document.getElementById('send-btn').onclick = sendMsg;
        document.getElementById('msg-input').onkeypress = (e) => e.key === 'Enter' && sendMsg();

    </script>
</body>
</html>
